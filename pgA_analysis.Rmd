---
title: "Pilgrim A  - Analysis with R"
author: "mpavlin@wlu.ca"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## The data
Goal in this case is to understand how being online is related to customer profits.
```{r}
pgdata <- read.csv("pilgrim_bank_data.csv")
summary(pgdata)
str(pgdata)
```

* How does the format of the data look? Were the datatypes correctly inferred? 
    + X9District is of the wrong type - it should be a category!

```{r}
pgdata$X9District <- as.factor(pgdata$X9District)
str(pgdata)
```

## Describing the data
* What does the profitability of these customers look like?
    + histogram gives an empirical estimate of the PDF of the variable
```{r}
hist(pgdata$X9Profit)
```

* Plot the proportion of profits below a particular level
    + the empirical cumulative distribution
```{r}
plot(ecdf(pgdata$X9Profit))
```

* Scatter plots between variables can give an idea of degree of relationships between dependent and independent variables and degree of collinearity between variables
```{r}
plot(pgdata$X9Age,pgdata$X9Profit)
```
Scatter plots en masse
```{r}
pairs(~X9Age+X9Inc+X9Tenure+X9Profit,data=pgdata[sample(nrow(pgdata),100),],main="Plots")
```

## Descriptive analysis with regression

Regression can quantify the relationship between profits and being an "online customer"

* A simple linear regression uses the lm function (linear model)
* Uses a \"formula\" to describe the regression equation (see tutorial 2)
```{r}
fit1 <- lm(X9Profit ~ X9Online, data=pgdata)
summary(fit1)
```

* What are the coefficients are they statistically significant?
* What can we conclude from this? 
    + Does being online result in higher or lower profits?
    + Is online status correlated with higher profist?
    + Are profits from the online population different than offline?
* Note poor p-values mean we can't reject the null hypothesis.
* How can we solve this:
    + Find more data (not possible)
    + Build a better model: if online customers are different from offline users we may benefit from controlling for other variables by including them in the regression.
    + Perhaps online users are a young tech savvy demographic which eschews human contact and are thus much cheaper to serve
    + Well then lets control for age
* If we perform regression with age as well as online channel on profit

```{r}
fit2 <- lm(X9Profit ~ X9Online+X9Age, data=pgdata)
summary(fit2)
```

* Coefficients are very significant!
* But note that some rows have been deleted!

## Dealing with missing data

* Default action for lm() is to delete rows which contain missing data (NAs)
* This is an easy way to deal with missing elements
    + But it could be adding substantial bias
    The deleted rows are only okay if: we have a ton of data so it doesn't make it much less statistically signifcant 
    OR if the ones deleted follow a random distribution (i.e. random deleted), if they was a patterrn thats a problem 

### Activity: check whether the age data is missing in a biased manner. Then complete the quiz.

Handling the missing age and income data

* Strategy 1: delete rows with missing data
* Strategy 2: give default value to missing data
* Strategy 3: give default value to missing data and a dummy variable indicating whether data was missing
    + An age exists column which would contain some of the information we can't observe about why the data was deleted
* Strategy 4: impute the missing data

We will use Strategy 3

```{r}
pgdata$AgeExists <- !is.na(pgdata$X9Age) 
meanAge <-mean(pgdata$X9Age[pgdata$AgeExists])
pgdata$AgeMeaned <- pgdata$X9Age
pgdata$AgeMeaned[is.na(pgdata$AgeMeaned)]<-meanAge

pgdata$IncExists <- !is.na(pgdata$X9Inc) 
meanInc <-mean(pgdata$X9Inc[pgdata$IncExists])
pgdata$IncMeaned <- pgdata$X9Inc
pgdata$IncMeaned[is.na(pgdata$IncMeaned)]<-meanInc
```
## Now we are ready to test out our hypothesis (we have one right?)

Try the big model

```{r}
bigFit = lm(X9Profit ~ X9Online + AgeExists + AgeMeaned + IncMeaned + X9Tenure + X9District, data=pgdata)
summary(bigFit)
```

Do the results support our hypothesis? are they inconclusive or are they against the hypothesis?

## Imputation predicts the missing data 

* Below is a simple means of imputating the missing age data
* There are more complex methods (e.g. multiple imputation) that might do a little bit better
(I did not include income because it has many missing values as well)

1. build a prediction model of the missing ages
```{r}
fitAge <- lm(X9Age ~ X9Online + X9Tenure + X9District + X9Billpay, data=pgdata)
```
2. predict missing ages using the predict function
```{r}
pgdata$AgeImpt <- pgdata$X9Age
pgdata$AgeImpt[is.na(pgdata$AgeImpt)]<-predict(fitAge, pgdata[is.na(pgdata$X9Age),])
plot(pgdata$AgeImpt,pgdata$AgeMeaned)
```

## Evaluating the fit

Are the residuals normally distributed?

```{r}
qqnorm(resid(bigFit))
```

Are the residuals homoskedastic?

```{r}
plot(fitted(bigFit),resid(bigFit))
```

* Collinearity tests
    + VIF variance inflation factor

We need the \"car\" regression diagnostics library

* Install the library from cran by running install.packages("car") in the console
* Load the library by running library(car) in the console

```{r warning=FALSE}
library(car)
```
```{r}
vif(bigFit)
```

* what happens if we add the income exists column to the regression?
* what happens to the VIF?

```{r}
bigFit2 <- lm(X9Profit ~ X9Online + AgeExists + AgeMeaned + IncMeaned + X9Tenure + X9District + IncExists, data=pgdata)
vif(bigFit2)
```

* what happens to the p-values?
```{r}
summary(bigFit2)
```

Why? Income and age data is missing from more or less the same individuals so those columns are highly collinear.