---
title: "NetworkAnalysis"
author: "mpavlin@wlu.ca"
date: "March 15, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## A short tutorial on igraph and networks in R

### Preliminaries

* If you don't yet have it install igraph and dplyr
```{r warning=FALSE}
library(igraph)
library(dplyr)
```

###Problem and dataset

* Before doing an analysis we should figure out the question we are trying to answer
    + "What cities in the US are most critical for the automotive industry?"
    + A bit vague but can be approached with an exploratory analysis of supply chain relationships between cities
    + These relationships will be complicated but... suggest a network analysis approach
* Load in our dataset
    + The dataset is a list of shipments from US Commodity Flow 
    + All automotive shipments in the 1st quarter of 2012
```{r}
dta <- read.csv("US_AUTO_SHIPMENTS_2012_Q1.csv")
dta[1:5,]
```

### Building the network

To build the network we need to decide on the

* Nodes 
    +There are multiple different location variables that could be used e.g. state or county
      +We will use the county (CFS_AREA)
* Edges (links)
    +What relationships between nodes are we interested in
    +"was there a shipment from county A to county B"
    +Each row provides this type of relationship
    +We can also specify a weight for the edges - it should be something that makes sense given the analysis question
* Building the network in igraph requires building the set of edges
    +There is one row per edge
    +The first column is the id of the origin node
    +The second column is the id of the destination node
    +The third column is the weight
    +Can be done with dplyr (group_by, summarize)
    +This will eliminate redundant edges (multiple edges with the same origin and destination)
```{r}
edges_ma <- dta[,c("ORIG_CFS_AREA","DEST_CFS_AREA","SHIPMT_VALUE")]
edges_g <- group_by(edges_ma,ORIG_CFS_AREA,DEST_CFS_AREA)
edges_small <- summarize(edges_g,wt=sum(SHIPMT_VALUE))

# turn it into a graph
net <- graph_from_data_frame(d=edges_small, directed=T)
```

### Accessing components of the network

* igraph contains various functions which can be used to retrieve components of the network such as the  edges and their weights.
```{r eval=FALSE}
# get list of edges
as_edgelist(net, names=T)
E(net)
# weights 
E(net)$wt
# vertex list
V(net)
names <- V(net)$name
# get adjacency matrix
as_adjacency_matrix(net, attr="weight")
```

### Visualizing the network

* To gain perspective on the network we can draw it
* But if we are naive it will look like garbage
```{r}
plot(net, edge.arrow.size=0,vertex.label=NA,vertex.size=3)
```

* We need to simplify the network
* simplify command is very useful for removing self loops and redundant connections
```{r}
plot(simplify(net), edge.arrow.size=0,vertex.label=NA,vertex.size=3)
```

* Often we can draw a lot better if we just consider the most important connections
* We will keep only the edges with weight larger than the mean (note that the distribution of weights is highly skewed)
```{r}
summary(E(net)$wt)
```
```{r}
net2 <- subgraph.edges(net, which(E(net)$wt >= 22431))
plot(simplify(net2), edge.arrow.size=0,vertex.label=NA,vertex.size=2)
```

* now it is starting to look a little nicer!

* We can now experiment with some different layouts
```{r}
# try some other layouts
plot(simplify(net2), edge.arrow.size=0,vertex.label=NA,vertex.size=2,layout=layout_as_star(net))
plot(simplify(net2), edge.arrow.size=0,vertex.label=NA,vertex.size=2,layout=layout_with_graphopt(net))
```

* It would be nice to try and draw this network on a map of the USA... however, that is beyond the scope of this class

### characteristics of nodes and the network

* We should consider some traditionally important locations like Detroit
* Detroit is identified in the dataset as "26-220"
* How important is 26-220?

Assess node degree for detroit
```{r}
degree(net2, v=V(net2)["26-220"])
# how does that compare to all the other nodes
deg <- degree(net2, mode="all")
mean(deg)
```

* Since this network is directed we can consider the indegree and outdegree
* What would it mean if the indegree was much larger than the outdegree?
* We can assess Detroit's degree relative to the others
```{r}
# indegree for all nodes
din <- degree(net2, mode="in")
dout <- degree(net2, mode="out")
# how is detroit ranked by degree
which(names(sort(din))=="26-220")
which(names(sort(dout))=="26-220")
```

* What would closeness centrality mean in this context?
* Closeness (centrality based on distance to others in the graph)
* Inverse of the node's average minimum distance to (geodesic distance) to other nodes.
```{r}
cls <- closeness(net2, mode="all", weights=NA)
```

* Betweenness (centrality based on a broker position connecting others)
    + Number of shortest paths that pass through the node.
```{r}
btwn <- betweenness(net2, directed=T, weights=NA)
```

* Shortest paths can also be assessed with or without edge weights
* In this context would it make sense to consider weights?
```{r}
dist <- distances(net2) # with edge weights
dist <- distances(net2, weights=NA) # ignore weights
# shortest distance from Detroit to LA
dist["26-220","06-348"]
# shortest path from Detroit to LA
pth <- shortest_paths(net2, 
					from = V(net2)["26-220"], 
					to  = V(net2)["06-348"],
                    output = "both") 
```

### How important is Detroit?
```{r}
which(names(sort(din))=="26-220")
which(names(sort(dout))=="26-220")
which(names(sort(cls))=="26-220")
which(names(sort(btwn))=="26-220")
```